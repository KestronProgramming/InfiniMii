<!DOCTYPE html>
<html>
    <head>
        <%
        const pageTitle = 'My Private Miis - InfiniMii';
        const pageDesc = 'Manage your private Mii collection. Review, edit, and publish your Miis when ready.';
        const canonicalUrl = `${baseUrl}/myPrivateMiis`;
        const keywords = 'private miis, mii collection, manage miis';
        %>
        <%- include('metaTags') %>
        <%- include('structuredData') %>
        <link rel='stylesheet' href="/global.css">
        <link rel="stylesheet" href="/utilityPages.css">
        <link rel="stylesheet" href="/privateMiis.css">
    </head>
    <body>
        <%- include('globalStyle') %>
        <%- include('header') %>
        <%- include('accountDisplay') %>
        <script src="/global.js"></script>
        <main class='content' role="main">
            <%- include('sidebar') %>
            <div class='private-miis-container'>
                <div class="private-header">
                    <h1><span class="emoji">üîí</span> My Private Miis</h1>
                    <p class="limit-info">
                        <%= privateMiis.length %> / <%= privateLimit %> private Miis
                    </p>
                </div>

                <% if(privateMiis.length > 0) { %>
                    <div id="private-miis-grid">
                        <% for(var i=0; i<privateMiis.length; i++){ %>
                            <article class="private-mii-card" data-mii-id="<%= privateMiis[i].id %>" style="--favorite-color: <%= decodeColor(privateMiis[i].general?.favoriteColor) || decodeColor(0) %>;">
                                <a href="<%= '/mii/'+privateMiis[i].id %>" aria-label="View <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                    <img src="/privateMiiImgs/<%= privateMiis[i].id %>.png" 
                                         onerror="this.src='/privateMiiImgs/<%= privateMiis[i].id %>.png'"
                                         alt="<%= privateMiis[i].meta?.name || privateMiis[i].name %>"
                                         loading="lazy">
                                </a>
                                <div class="mii-info">
                                    <h3><%= privateMiis[i].meta?.name || privateMiis[i].name %></h3>
                                    <% if(privateMiis[i].desc) { %>
                                        <p class="mii-desc">
                                            <%= privateMiis[i].desc.length > 80 ? 
                                                privateMiis[i].desc.substring(0, 80) + '...' : 
                                                privateMiis[i].desc %>
                                        </p>
                                    <% } %>
                                    <% if(privateMiis[i].blockedFromPublishing) { %>
                                        <div class="blocked-notice">
                                            üö´ Blocked from publishing
                                            <% if(privateMiis[i].blockReason) { %>
                                                <small><%= privateMiis[i].blockReason %></small>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="mii-actions">
                                    <% if(!privateMiis[i].blockedFromPublishing) { %>
                                        <button class="publish-btn" onclick="publishMii('<%= privateMiis[i].id %>')" aria-label="Publish <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                            üì§ Publish
                                        </button>
                                    <% } %>
                                    <button class="delete-btn" onclick="deleteMii('<%= privateMiis[i].id %>')" aria-label="Delete <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </article>
                        <% } %>
                    </div>
                <% } else { %>
                    <div class="no-miis">
                        <p>You don't have any private Miis yet.</p>
                        <a href="/upload" class="upload-button">üì§ Upload Your First Mii</a>
                    </div>
                <% } %>
            </div>
            <%- include('featuredMiis') %>
        </main>
        <%- include('footer') %>
        
        <script>
            async function publishMii(miiId) {
                showConfirm('Are you sure you want to publish this Mii? It will be visible to everyone.', async () => {
                    try {
                        const response = await fetch('/publishMii', {
                            method: 'POST',
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ miiId })
                        });
                        
                        const data = await response.json();
                        
                        if (!data.error) {
                            showAlert('Mii published successfully!', 3000, { title: 'Success', type: 'success' });
                            setTimeout(() => location.reload(), 3000);
                        } else {
                            showAlert('Error: ' + (data.error || 'Failed to publish Mii'), 5000, { title: 'Error', type: 'error' });
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert('Error publishing Mii', 5000, { title: 'Error', type: 'error' });
                    }
                }, null, { title: 'Publish Mii', confirmText: 'Publish' });
            }
            
            async function deleteMii(miiId) {
                showConfirm('Are you sure you want to delete this Mii? This cannot be undone.', async () => {
                    try {
                        const response = await fetch('/deleteMii', {
                            body: JSON.stringify({ miiId }),
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                        });
                        const data = await response.text();
                        
                        if (data.includes('true')) {
                            showAlert('Mii deleted successfully', 3000, { title: 'Success', type: 'success' });
                            setTimeout(() => location.reload(), 3000);
                        } else {
                            showAlert('Error deleting Mii', 5000, { title: 'Error', type: 'error' });
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert('Error deleting Mii', 5000, { title: 'Error', type: 'error' });
                    }
                }, null, { title: 'Delete Mii', confirmText: 'Delete' });
            }
        </script>
    </body>
</html>