<!DOCTYPE html>
<html>
	<head>
		<title>Settings - InfiniMii</title>
		<link rel="stylesheet" href="./global.css">
        <link rel="stylesheet" href="utilityPages.css">
	</head>
	<body>
        <%- include('globalStyle') %>
		<%- include('header') %>
		<%- include('accountDisplay') %>
		<div class="content">
			<%- include('sidebar') %>
			<div class="settings-container">
				<div id="settings-message" class="form-message" style="display: none; margin-bottom: 20px;"></div>
				
				<fieldset>
					<legend>Profile Settings</legend>
					
					<!-- Change Profile Picture -->
					<div class="setting-group">
						<label>Profile Picture (Mii ID)</label>
						<input type="text" placeholder="Mii ID for new Profile Picture" id="pfpId">
						<button onclick="changePfp()">Change Profile Picture</button>
					</div>

					<!-- Change Username -->
					<div class="setting-group">
						<label>Username</label>
						<p style="color: var(--text-2); font-size: 0.9em; margin: 5px 0;">‚ÑπÔ∏è You can only change your username once per month.</p>
						<input type="text" placeholder="New Username" id="nUser">
						<input type="password" placeholder="Current Password" id="userChangePassword">
						<button onclick="changeUser()">Change Username</button>
					</div>
				</fieldset>

				<fieldset>
					<legend>Account Settings</legend>

					<!-- Change Email -->
					<div class="setting-group">
						<label>Email Address</label>
						<input type="email" placeholder="New Email" id="nEmail">
						<button onclick="changeEmail()">Change Email</button>
					</div>
					
					<!-- Change Password -->
					<div class="setting-group">
						<label>Password</label>
						<input type="password" placeholder="Old Password" id="oPass">
						<input type="password" placeholder="New Password" id="nPass">
						<button onclick="changePassword()">Change Password</button>
					</div>
				</fieldset>

				<fieldset class="danger-zone">
					<legend>‚ö†Ô∏è Danger Zone</legend>

					<!-- Delete All Miis -->
					<div class="setting-group">
						<label>Delete All Your Miis</label>
						<p class="warning-text">This will permanently delete ALL Miis you have uploaded. This action cannot be undone!</p>
						<button class="danger-btn" onclick="deleteAllMiis()">üóëÔ∏è Delete All My Miis</button>
					</div>

					<!-- Delete Account -->
					<div class="setting-group">
						<label>Delete Account</label>
						<p class="warning-text">This will permanently delete your account. Your Miis will remain on the site but will be attributed to "[Deleted User]". This action cannot be undone!</p>
						<input type="password" placeholder="Enter Password to Confirm" id="deleteAccountPassword">
						<button class="danger-btn" onclick="deleteAccount()">‚õî Delete Account</button>
					</div>
				</fieldset>
			</div>

            <%- include('featuredMiis') %>
		</div>
		<%- include('footer') %>
		<script src="/global.js"></script>
		<script>
			function showMessage(text, type = 'error') {
				const messageDiv = document.getElementById('settings-message');
				messageDiv.textContent = text;
				messageDiv.className = `form-message ${type}`;
				messageDiv.style.display = 'block';
				messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
			}
			
			async function changePfp() {
				const pfpId = document.getElementById('pfpId').value;
				if (!pfpId) {
					alert('Please enter a Mii ID');
					return;
				}

				try {
					const response = await fetch(`/changePfp`, {
						method: "POST",
						body: JSON.stringify({ id: encodeURIComponent(pfpId) }),
						headers: { "Content-Type": "application/json" },
					});
					const result = await response.json();
					
					if (!result.error) {
						alert('Profile picture changed successfully!');
						location.reload();
					}
                    else {
						alert(result.error || 'Error changing profile picture');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to change profile picture');
				}
			}

			async function changeUser() {
				const newUsername = document.getElementById('nUser').value;
				const password = document.getElementById('userChangePassword').value;
				const messageDiv = document.getElementById('settings-message');
				
				if (!newUsername || !password) {
					showMessage('Please enter both a new username and your password', 'error');
					return;
				}

				const confirmed = confirm(`Are you sure you want to change your username to "${newUsername}"?\nYou won't be able to change it again for 30 days.`);
				if (!confirmed) return;

				try {
					const response = await fetch('/changeSelfUsername', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ newUsername, password })
					});
					const result = await response.json();
					
					if (!result.error) {
						showMessage(result.message || 'Username changed successfully!', 'success');
						document.getElementById('nUser').value = '';
						document.getElementById('userChangePassword').value = '';
						setTimeout(() => {
							if (result.redirect) window.location.href = result.redirect;
							else location.reload();
						}, 2000);
					} else {
						showMessage(result.error, 'error');
					}
				} catch (error) {
					console.error('Error:', error);
					showMessage('Failed to change username', 'error');
				}
			}

			async function changeEmail() {
				const newEmail = document.getElementById('nEmail').value;

				if (!newEmail) {
					alert('Please fill in both old and new email');
					return;
				}

				try {
					const response = await fetch('/changeEmail', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ newEmail })
					});

					const result = await response.json();
					
					if (!result.error) {
						alert('Email changed successfully!');
						document.getElementById('nEmail').value = '';
					}
                    else {
						alert(result.error || 'Error changing email');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to change email');
				}
			}

			async function changePassword() {
				const oldPass = document.getElementById('oPass').value;
				const newPass = document.getElementById('nPass').value;

				if (!oldPass || !newPass) {
					alert('Please fill in both old and new password');
					return;
				}

				if (newPass.length < 6) {
					alert('New password must be at least 6 characters');
					return;
				}

				try {
					const response = await fetch('/changePassword', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })
					});

					const result = await response.json();
					
					if (!result.error) {
						alert('Password changed successfully!');
						document.getElementById('oPass').value = '';
						document.getElementById('nPass').value = '';
					}
                    else {
						alert(result.error || 'Error changing password');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to change password');
				}
			}

			async function deleteAllMiis() {
				const confirmed = confirm('‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nAre you ABSOLUTELY SURE you want to DELETE ALL YOUR MIIS?\n\nThis action CANNOT be undone!');
				if (!confirmed) return;

				const doubleCheck = prompt('Type "DELETE ALL" to confirm:');
				if (doubleCheck !== 'DELETE ALL') {
					alert('Deletion cancelled.');
					return;
				}

				try {
					const response = await fetch('/deleteAllMyMiis', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' }
					});

					const result = await response.json();
					
					if (!result.error) {
						alert(`Successfully deleted ${result.deletedCount} Miis`);
						location.reload();
					}
                    else {
						alert(result.error || 'Error deleting Miis');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to delete Miis');
				}
			}

			async function deleteAccount() {
				const password = document.getElementById('deleteAccountPassword').value;

				if (!password) {
					alert('Please enter your password to confirm account deletion');
					return;
				}

				const confirmed = confirm('‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\nAre you ABSOLUTELY SURE you want to DELETE YOUR ACCOUNT?\n\nYour Miis will remain on the site but will be attributed to "[Deleted User]".\n\nThis action CANNOT be undone!');
				if (!confirmed) return;

				const tripleCheck = prompt('Type "DELETE MY ACCOUNT" to confirm:');
				if (tripleCheck !== 'DELETE MY ACCOUNT') {
					alert('Account deletion cancelled.');
					return;
				}

				try {
					const response = await fetch('/deleteAccount', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ password })
					});

					const result = await response.json();
					
					if (!result.error) {
						alert('Account deleted successfully. Goodbye!');
						window.location.href = '/';
					}
                    else {
						alert(result.error || 'Error deleting account');
					}
				} catch (error) {
					console.error('Error:', error);
					alert('Failed to delete account');
				}
			}
		</script>
	</body>
</html>